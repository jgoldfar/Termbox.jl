using BinaryProvider # requires BinaryProvider 0.3.0 or later

# Parse some basic command-line arguments
const verbose = "--verbose" in ARGS
const prefix = Prefix(get([a for a in ARGS if a != "--verbose"], 1, joinpath(@__DIR__, "usr")))
products = [
    LibraryProduct(prefix, String["libtermbox"], :libtermbox),
]

# Download binaries from hosted location
bin_prefix = "https://github.com/jgoldfar/TermboxBuilder/releases/download/v1.1.0"

# Listing of files generated by BinaryBuilder:
download_info = Dict(
    Linux(:aarch64, :glibc) => ("$bin_prefix/TermboxBuilder.v1.1.0.aarch64-linux-gnu.tar.gz", "f3d0f58ef798d727c8db18bcab89153454044b6e48050ca394f84d8896bc6376"),
    Linux(:aarch64, :musl) => ("$bin_prefix/TermboxBuilder.v1.1.0.aarch64-linux-musl.tar.gz", "dd7ebcecd1af4e968854e753aab5600cc17f5a618eeb66355736cd88b7708e1e"),
    Linux(:armv7l, :glibc, :eabihf) => ("$bin_prefix/TermboxBuilder.v1.1.0.arm-linux-gnueabihf.tar.gz", "f857a9f17262eb924149db45a782e4a8e510e89f14fae8c93f1c51a0c34d8616"),
    Linux(:armv7l, :musl, :eabihf) => ("$bin_prefix/TermboxBuilder.v1.1.0.arm-linux-musleabihf.tar.gz", "d9c7e872da09550868592a6cf8014ff3324a3b3896c723f1a30c114f34e31e88"),
    Linux(:i686, :glibc) => ("$bin_prefix/TermboxBuilder.v1.1.0.i686-linux-gnu.tar.gz", "39ed0cfe810626fc2314832905a0d861e1daca98e09228a9e2ae27361bbb148e"),
    Linux(:i686, :musl) => ("$bin_prefix/TermboxBuilder.v1.1.0.i686-linux-musl.tar.gz", "0a05b21d1c866d3fbc237385f2a4ad408d356ffb13e46da6780bc90f3f2f6f82"),
    Linux(:powerpc64le, :glibc) => ("$bin_prefix/TermboxBuilder.v1.1.0.powerpc64le-linux-gnu.tar.gz", "95de264d3d7a577a5efa269c6c3686e8011e3a21d9101d6133aaa5b35b8fb034"),
    MacOS(:x86_64) => ("$bin_prefix/TermboxBuilder.v1.1.0.x86_64-apple-darwin14.tar.gz", "d29f19bd8196fdf5b52c8615f28222c1575741702a7b2941a2069998dd7a4ac9"),
    Linux(:x86_64, :glibc) => ("$bin_prefix/TermboxBuilder.v1.1.0.x86_64-linux-gnu.tar.gz", "7735baa22963b82dd5290f555345f919592ff685f6c3b5eb62b8d7a629834fb8"),
    Linux(:x86_64, :musl) => ("$bin_prefix/TermboxBuilder.v1.1.0.x86_64-linux-musl.tar.gz", "30c4e2e2a1c86387d8788690da48dd243771070f1c0824ebc5c436231101cc6d"),
    FreeBSD(:x86_64) => ("$bin_prefix/TermboxBuilder.v1.1.0.x86_64-unknown-freebsd11.1.tar.gz", "180235871a1393e746a926f1f53e7b660c1b3420efe77fd3838c18fd39b3e3de"),
)

# Install unsatisfied or updated dependencies:
unsatisfied = any(!satisfied(p; verbose=verbose) for p in products)
if haskey(download_info, platform_key())
    url, tarball_hash = download_info[platform_key()]
    if unsatisfied || !isinstalled(url, tarball_hash; prefix=prefix)
        # Download and install binaries
        install(url, tarball_hash; prefix=prefix, force=true, verbose=verbose)
    end
elseif unsatisfied
    # If we don't have a BinaryProvider-compatible .tar.gz to download, complain.
    # Alternatively, you could attempt to install from a separate provider,
    # build from source or something even more ambitious here.
    error("Your platform $(triplet(platform_key())) is not supported by this package!")
end

# Write out a deps.jl file that will contain mappings for our products
write_deps_file(joinpath(@__DIR__, "deps.jl"), products, verbose=verbose)
